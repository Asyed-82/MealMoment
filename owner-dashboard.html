// Add these functions to your existing owner dashboard script

// 1. Enhanced Dish Filtering and Search
function setupDishFilters() {
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = 'Search dishes...';
    searchInput.style.cssText = 'width: 100%; padding: 0.875rem 1rem; border: 2px solid var(--mm-gray-200); border-radius: var(--radius-md); margin-bottom: var(--space-md);';
    searchInput.onkeyup = filterDishes;
    
    const dishesSection = document.querySelector('.dishes-section');
    dishesSection.insertBefore(searchInput, dishesSection.querySelector('#dishes-container'));
    
    // Add category filter
    const filterContainer = document.createElement('div');
    filterContainer.style.cssText = 'display: flex; gap: var(--space-sm); margin-bottom: var(--space-md);';
    
    const allBtn = createFilterButton('All', 'all', true);
    const approvedBtn = createFilterButton('Approved', 'approved');
    const pendingBtn = createFilterButton('Pending', 'pending');
    const activeBtn = createFilterButton('Active', 'active');
    const inactiveBtn = createFilterButton('Inactive', 'inactive');
    
    filterContainer.append(allBtn, approvedBtn, pendingBtn, activeBtn, inactiveBtn);
    dishesSection.insertBefore(filterContainer, dishesSection.querySelector('#dishes-container'));
}

function createFilterButton(text, filter, isActive = false) {
    const button = document.createElement('button');
    button.textContent = text;
    button.className = 'filter-btn';
    button.style.cssText = 'padding: 0.5rem 1rem; border: 2px solid var(--mm-gray-200); border-radius: var(--radius-md); background: white; cursor: pointer;';
    if (isActive) button.style.borderColor = 'var(--mm-green)';
    
    button.onclick = () => {
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.style.borderColor = 'var(--mm-gray-200)';
        });
        button.style.borderColor = 'var(--mm-green)';
        filterDishes();
    };
    
    button.dataset.filter = filter;
    return button;
}

// 2. Enhanced Form Validation
function validateDishForm() {
    const name = document.getElementById('dish-name').value.trim();
    const price = document.getElementById('dish-price').value;
    const cuisine = document.getElementById('dish-cuisine').value;
    
    const errors = [];
    
    if (!name) errors.push('Dish name is required');
    if (!price || parseFloat(price) <= 0) errors.push('Valid price is required');
    if (!cuisine) errors.push('Cuisine type is required');
    
    // Image validation (optional but with size check)
    const imageFile = document.getElementById('dish-image').files[0];
    if (imageFile && imageFile.size > 2 * 1024 * 1024) {
        errors.push('Image size must be less than 2MB');
    }
    
    if (errors.length > 0) {
        showMessage(errors.join('<br>'), 'error');
        return false;
    }
    
    return true;
}

// 3. Status Toggling (Active/Inactive)
async function toggleDishStatus(dishId, currentStatus) {
    try {
        await db.collection('dishes').doc(dishId).update({
            isActive: !currentStatus,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        await loadDishes();
        showMessage(`Dish ${!currentStatus ? 'activated' : 'deactivated'} successfully!`, 'success');
    } catch (error) {
        console.error('Error toggling dish status:', error);
        showMessage('Error updating dish status', 'error');
    }
}

// 4. Real-time Updates
function setupRealTimeListeners() {
    // Listen for dish updates
    db.collection('dishes')
        .where('restaurantId', '==', currentUser.uid)
        .onSnapshot((snapshot) => {
            dishes = [];
            snapshot.forEach(doc => {
                dishes.push({ id: doc.id, ...doc.data() });
            });
            renderDishes();
            updateStats();
        });
    
    // Listen for order updates
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    db.collection('orders')
        .where('restaurantId', '==', currentUser.uid)
        .where('createdAt', '>=', today)
        .onSnapshot((snapshot) => {
            document.getElementById('today-orders').textContent = snapshot.size;
        });
}

// 5. Enhanced Dish Rendering with Edit functionality
function renderDishes() {
    const container = document.getElementById('dishes-container');
    const searchTerm = document.querySelector('input[placeholder="Search dishes..."]')?.value.toLowerCase() || '';
    const activeFilter = document.querySelector('.filter-btn[style*="border-color: var(--mm-green)"]')?.dataset.filter || 'all';
    
    if (dishes.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: var(--space-xl); grid-column: 1/-1;">
                <i class="fas fa-utensils" style="font-size: 3rem; color: var(--mm-gray-200);"></i>
                <p>No dishes added yet. Add your first dish!</p>
            </div>
        `;
        return;
    }
    
    // Filter dishes
    let filteredDishes = dishes;
    
    if (searchTerm) {
        filteredDishes = filteredDishes.filter(dish => 
            dish.name.toLowerCase().includes(searchTerm) ||
            (dish.description && dish.description.toLowerCase().includes(searchTerm)) ||
            dish.cuisine.toLowerCase().includes(searchTerm)
        );
    }
    
    if (activeFilter !== 'all') {
        filteredDishes = filteredDishes.filter(dish => {
            if (activeFilter === 'approved') return dish.status === 'approved';
            if (activeFilter === 'pending') return dish.status === 'pending';
            if (activeFilter === 'active') return dish.isActive === true;
            if (activeFilter === 'inactive') return dish.isActive === false;
            return true;
        });
    }
    
    if (filteredDishes.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: var(--space-xl); grid-column: 1/-1;">
                <i class="fas fa-search" style="font-size: 3rem; color: var(--mm-gray-200);"></i>
                <p>No dishes match your criteria</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = filteredDishes.map(dish => `
        <div class="dish-card ${dish.status === 'approved' ? 'approved' : 'pending'}">
            <div class="status-badge ${dish.status === 'approved' ? 'status-approved' : 'status-pending'}">
                ${dish.status === 'approved' ? 'APPROVED' : 'PENDING'}
            </div>
            <div style="position: absolute; top: 10px; left: 10px;">
                <span class="status-badge ${dish.isActive ? 'status-approved' : 'status-pending'}" style="position: relative; top: 0; right: 0;">
                    ${dish.isActive ? 'ACTIVE' : 'INACTIVE'}
                </span>
            </div>
            <div class="dish-image">
                ${dish.imageUrl ? 
                    `<img src="${dish.imageUrl}" alt="${dish.name}">` :
                    `<i class="fas fa-utensils" style="font-size: 3rem; color: var(--mm-gray-200);"></i>`
                }
            </div>
            <h4>${dish.name}</h4>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">${dish.description || 'No description'}</p>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <div>
                    <strong style="color: var(--mm-green); font-size: 1.25rem;">$${dish.price?.toFixed(2) || '0.00'}</strong>
                    <div style="font-size: 0.875rem; color: #666;">${dish.cuisine} â€¢ ${dish.calories || 'N/A'} cal</div>
                </div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary" onclick="editDish('${dish.id}')" style="flex: 1; padding: 0.5rem; font-size: 0.875rem;">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn btn-secondary" onclick="toggleDishStatus('${dish.id}', ${dish.isActive})" style="flex: 1; padding: 0.5rem; font-size: 0.875rem;">
                    <i class="fas fa-power-off"></i> ${dish.isActive ? 'Deactivate' : 'Activate'}
                </button>
                <button class="btn btn-secondary" onclick="deleteDish('${dish.id}')" style="padding: 0.5rem; font-size: 0.875rem;">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
}

// 6. Edit Dish Functionality
async function editDish(dishId) {
    try {
        const dishDoc = await db.collection('dishes').doc(dishId).get();
        const dish = dishDoc.data();
        
        // Populate form with dish data
        document.getElementById('dish-name').value = dish.name;
        document.getElementById('dish-price').value = dish.price;
        document.getElementById('dish-cuisine').value = dish.cuisine;
        document.getElementById('dish-calories').value = dish.calories || '';
        document.getElementById('dish-description').value = dish.description || '';
        
        // Show image preview
        if (dish.imageUrl) {
            document.getElementById('image-preview').innerHTML = `
                <img src="${dish.imageUrl}" style="max-width: 200px; border-radius: var(--radius-md);">
                <p style="font-size: 0.875rem; color: #666;">Current image</p>
            `;
        }
        
        // Change button to update
        const addButton = document.querySelector('.add-dish-form .btn-primary');
        addButton.innerHTML = '<i class="fas fa-save"></i> Update Dish';
        addButton.onclick = () => updateDish(dishId);
        
        // Add cancel button
        if (!document.getElementById('cancel-edit-btn')) {
            const cancelBtn = document.createElement('button');
            cancelBtn.id = 'cancel-edit-btn';
            cancelBtn.className = 'btn btn-secondary';
            cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
            cancelBtn.style.marginLeft = '1rem';
            cancelBtn.onclick = cancelEdit;
            addButton.parentNode.appendChild(cancelBtn);
        }
        
        // Scroll to form
        document.querySelector('.add-dish-form').scrollIntoView({ behavior: 'smooth' });
        
    } catch (error) {
        console.error('Error loading dish for edit:', error);
        showMessage('Error loading dish', 'error');
    }
}

async function updateDish(dishId) {
    if (!validateDishForm()) return;
    
    const name = document.getElementById('dish-name').value;
    const price = parseFloat(document.getElementById('dish-price').value);
    const cuisine = document.getElementById('dish-cuisine').value;
    const calories = document.getElementById('dish-calories').value;
    const description = document.getElementById('dish-description').value;
    const imageFile = document.getElementById('dish-image').files[0];
    
    try {
        const updateData = {
            name,
            price,
            cuisine,
            calories: parseInt(calories) || 0,
            description,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Upload new image if provided
        if (imageFile) {
            const storageRef = storage.ref(`dishes/${currentUser.uid}/${Date.now()}_${imageFile.name}`);
            await storageRef.put(imageFile);
            updateData.imageUrl = await storageRef.getDownloadURL();
        }
        
        await db.collection('dishes').doc(dishId).update(updateData);
        
        // Reset form
        cancelEdit();
        showMessage('Dish updated successfully!', 'success');
        
    } catch (error) {
        console.error('Error updating dish:', error);
        showMessage('Error updating dish', 'error');
    }
}

function cancelEdit() {
    resetDishForm();
    
    const addButton = document.querySelector('.add-dish-form .btn-primary');
    addButton.innerHTML = '<i class="fas fa-plus"></i> Add Dish';
    addButton.onclick = addDish;
    
    const cancelBtn = document.getElementById('cancel-edit-btn');
    if (cancelBtn) cancelBtn.remove();
}

// 7. Initialize enhanced dashboard
async function loadRestaurantData() {
    if (!currentUser) return;
    
    try {
        const restaurantDoc = await db.collection('restaurants')
            .doc(currentUser.uid)
            .get();
        
        if (restaurantDoc.exists) {
            restaurantData = restaurantDoc.data();
            updateRestaurantUI();
            
            // Load dishes
            await loadDishes();
            
            // Load stats
            await loadStats();
            
            // Setup real-time listeners
            setupRealTimeListeners();
            
            // Setup filters
            setupDishFilters();
            
        } else {
            // Create new restaurant document
            restaurantData = {
                name: 'My Restaurant',
                zipCode: '',
                cuisine: 'American',
                ownerId: currentUser.uid,
                ownerEmail: currentUser.email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                approvedDishCount: 0,
                totalDishCount: 0
            };
            
            await db.collection('restaurants').doc(currentUser.uid).set(restaurantData);
            updateRestaurantUI();
        }
    } catch (error) {
        console.error('Error loading restaurant data:', error);
        showMessage('Error loading restaurant data', 'error');
    }
}

// 8. Add CSS for filters
const style = document.createElement('style');
style.textContent = `
    .filter-btn:hover {
        background: var(--mm-bg-soft);
    }
    
    .filter-btn.active {
        border-color: var(--mm-green) !important;
        background: var(--mm-bg-soft);
    }
    
    .dish-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .dish-actions button {
        flex: 1;
    }
`;
document.head.appendChild(style);
